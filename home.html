<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>LB4 Messenger — Home</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
<style>
    :root {
        --bg-primary: #050505;
        --bg-secondary: #0d0d0d;
        --accent: #0ea5a0;
        --accent-hover: #0c8d89;
        --text-primary: #E0E0E0;
        --text-muted: #A0A0A0;
        --border-color: rgba(14, 165, 160, 0.15);
        --msg-sent-bg: #0ea5a0;
        --msg-received-bg: rgba(255, 255, 255, 0.05);
        --msg-status-color: #58D68D;
        --radius-default: 20px;
        --radius-small: 12px;
    }
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }
    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(180deg, #050505, #0b0b0b);
        color: var(--text-primary);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        overflow-x: hidden;
    }
    a {
        color: var(--text-muted);
        text-decoration: none;
        transition: color 0.3s;
    }
    a:hover {
        color: var(--accent);
    }
    button {
        transition: all 0.3s;
        cursor: pointer;
    }

    /* Notification Banner */
    .notification-banner {
        background: linear-gradient(135deg, rgba(14,165,160,0.15), rgba(14,165,160,0.05));
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px 20px;
        margin: 0 20px 15px;
        display: none;
        align-items: center;
        gap: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    .notification-banner.show {
        display: flex;
    }
    .notification-banner .material-icons-round {
        color: var(--accent);
        font-size: 28px;
    }
    .notification-banner .content {
        flex: 1;
    }
    .notification-banner h4 {
        margin: 0 0 4px;
        font-size: 1rem;
        color: var(--text-primary);
        border: none;
        padding: 0;
    }
    .notification-banner p {
        margin: 0;
        font-size: 0.85rem;
        color: var(--text-muted);
    }
    .notification-banner .btns {
        display: flex;
        gap: 8px;
    }
    .notification-banner button {
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.85rem;
        font-family: 'Inter', sans-serif;
    }
    .notification-banner .enable-btn {
        background: var(--accent);
        color: #fff;
    }
    .notification-banner .enable-btn:hover {
        background: var(--accent-hover);
    }
    .notification-banner .dismiss-btn {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-muted);
    }
    .notification-banner .dismiss-btn:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    /* Notification Badge */
    .notification-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background: #ff4d4d;
        color: #fff;
        border-radius: 10px;
        padding: 2px 6px;
        font-size: 0.7rem;
        font-weight: 700;
        min-width: 18px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(255, 77, 77, 0.5);
    }

    /* Layout */
    .main-container {
        max-width: 1400px;
        width: 100%;
        margin: 0 auto;
        padding: 10px;
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    .app {
        display: flex;
        gap: 20px;
        flex: 1;
        height: calc(100vh - 90px);
        min-height: 600px;
        max-height: calc(100vh - 90px);
        overflow: hidden;
    }
    .panel {
        background: linear-gradient(135deg, rgba(14,165,160,0.03), rgba(14,165,160,0.01));
        backdrop-filter: blur(10px);
        border-radius: var(--radius-default);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px var(--border-color);
        display: flex;
        flex-direction: column;
    }

    /* Header */
    header.top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        margin-bottom: 10px;
        background: linear-gradient(135deg, rgba(14,165,160,0.05), rgba(14,165,160,0.02));
        border-radius: var(--radius-default);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3), 0 0 0 1px var(--border-color);
    }
    .logo {
        display: flex;
        align-items: center;
        font-size: 24px;
        font-weight: 700;
        background: linear-gradient(135deg, #0ea5a0, #06d6d1);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .logo img {
        width: 40px;
        height: 40px;
        margin-right: 12px;
        border-radius: 50%;
        border: 2px solid rgba(14,165,160,0.3);
    }
    .me {
        display: flex;
        align-items: center;
        gap: 16px;
        font-size: 0.95rem;
    }
    .me a {
        padding: 8px 16px;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s;
        position: relative;
    }
    .me a:hover {
        background: rgba(14,165,160,0.15);
        color: var(--accent);
    }
    .small {
        color: var(--text-muted);
        font-size: 0.9rem;
        font-weight: 400;
    }

    /* Left Panel */
    .left {
        width: 380px;
        min-width: 350px;
        padding: 20px;
        overflow: hidden;
    }
    .search {
        margin-bottom: 20px;
    }
    input.search {
        width: 100%;
        padding: 12px 20px;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        background: rgba(14,165,160,0.05);
        color: var(--text-primary);
        outline: none;
        font-size: 1rem;
        font-family: 'Inter', sans-serif;
        transition: all 0.3s;
    }
    input.search:focus {
        border-color: var(--accent);
        background: rgba(14,165,160,0.08);
        box-shadow: 0 0 0 3px rgba(14,165,160,0.1);
    }
    input.search::placeholder {
        color: rgba(255,255,255,0.3);
    }

    .contacts-scroll {
        overflow-y: auto;
        flex: 1;
        padding-left: 5px;
    }
    .contacts-scroll::-webkit-scrollbar {
        width: 5px;
    }
    .contacts-scroll::-webkit-scrollbar-thumb {
        background: var(--accent);
        border-radius: 3px;
    }
    
    h4 {
        margin: 20px 0 12px;
        font-weight: 700;
        color: var(--text-primary);
        font-size: 1rem;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
    }
    h4:first-child {
        margin-top: 0;
    }

    .user-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-radius: var(--radius-small);
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 8px;
        border: 1px solid transparent;
        position: relative;
    }
    .user-row:hover {
        background: rgba(14,165,160,0.1);
        border-color: rgba(14,165,160,0.2);
    }
    .user-row.active {
        background: linear-gradient(135deg, var(--accent), var(--accent-hover));
        color: #fff;
        box-shadow: 0 4px 15px rgba(14,165,160,0.4);
        border-color: transparent;
    }
    .user-row.active .small {
        color: rgba(255,255,255,0.8);
    }

    .avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #0ea5a0, #06d6d1);
        display: flex;
        justify-content: center;
        align-items: center;
        color: #fff;
        font-weight: 700;
        font-size: 1.2rem;
        flex-shrink: 0;
        box-shadow: 0 2px 8px rgba(14,165,160,0.3);
        position: relative;
    }
    .user-row.active .avatar {
        background: #fff;
        color: var(--accent);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .name {
        font-weight: 600;
        font-size: 0.95rem;
    }

    /* Friend Requests */
    .req-box {
        background: rgba(14,165,160,0.05);
        border-radius: var(--radius-small);
        padding: 14px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--border-color);
    }
    .req-box p {
        margin: 0;
        font-size: 0.95rem;
    }
    .req-btns {
        display: flex;
        gap: 8px;
    }
    .req-btns button {
        padding: 8px 16px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.85rem;
        font-family: 'Inter', sans-serif;
    }
    .accept {
        background: var(--accent);
        color: #fff;
        box-shadow: 0 2px 8px rgba(14,165,160,0.3);
    }
    .accept:hover {
        background: var(--accent-hover);
        transform: translateY(-1px);
    }
    .reject {
        background: rgba(255,77,77,0.9);
        color: #fff;
        box-shadow: 0 2px 8px rgba(255,77,77,0.3);
    }
    .reject:hover {
        background: rgba(255,77,77,1);
        transform: translateY(-1px);
    }

    /* Right Panel - Chat */
    .right {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        max-height: 100%;
        min-height: 0;
    }
    #chatHeader {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 15px;
        padding: 18px 24px;
        border-bottom: 1px solid var(--border-color);
        background: rgba(14,165,160,0.03);
        border-top-left-radius: var(--radius-default);
        border-top-right-radius: var(--radius-default);
    }
    .back-btn {
        display: none;
        font-size: 28px;
        cursor: pointer;
        color: var(--text-primary);
        transition: color 0.3s;
    }
    .back-btn:hover {
        color: var(--accent);
    }
    
    .msg-area {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        gap: 12px;
        min-height: 0;
        max-height: 100%;
    }
    .msg-area::-webkit-scrollbar {
        width: 6px;
    }
    .msg-area::-webkit-scrollbar-thumb {
        background: var(--accent);
        border-radius: 3px;
    }

    /* Messages */
    .message-row {
        display: flex;
        width: 100%;
        margin: 4px 0;
    }
    .message-row.sent {
        justify-content: flex-end;
    }
    .message-row.received {
        justify-content: flex-start;
    }

    .message-bubble-wrapper {
        display: flex;
        flex-direction: column;
        max-width: 70%;
    }

    .message-content {
        padding: 12px 18px;
        line-height: 1.5;
        font-size: 0.95rem;
        word-wrap: break-word;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        position: relative;
        cursor: pointer;
        transition: all 0.2s;
    }
    .message-content:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.3);
    }

    .message-row.sent .message-content {
        background: linear-gradient(135deg, var(--msg-sent-bg), var(--accent-hover));
        color: #fff;
        border-radius: 18px 18px 4px 18px;
    }
    .message-row.received .message-content {
        background: var(--msg-received-bg);
        color: var(--text-primary);
        border-radius: 18px 18px 18px 4px;
        border: 1px solid var(--border-color);
    }

    .message-meta {
        font-size: 0.75rem;
        margin-top: 4px;
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--text-muted);
        padding: 0 6px;
    }
    .message-row.sent .message-meta {
        justify-content: flex-end;
    }
    .message-row.received .message-meta {
        justify-content: flex-start;
    }
    .message-status {
        font-weight: 600;
        color: var(--msg-status-color);
    }

    /* Message Actions Menu */
    .msg-actions {
        position: fixed;
        background: rgba(13, 13, 13, 0.98);
        backdrop-filter: blur(10px);
        border-radius: 10px;
        padding: 8px;
        display: none;
        gap: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5), 0 0 0 1px var(--border-color);
        z-index: 1000;
    }
    .msg-actions.show {
        display: flex;
    }
    .msg-actions button {
        background: transparent;
        border: none;
        color: var(--text-muted);
        padding: 6px 10px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-family: 'Inter', sans-serif;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 4px;
        white-space: nowrap;
    }
    .msg-actions button:hover {
        background: rgba(14, 165, 160, 0.15);
        color: var(--accent);
    }
    .msg-actions button.delete:hover {
        background: rgba(255, 77, 77, 0.15);
        color: #ff4d4d;
    }

    /* Reactions */
    .message-reactions {
        display: flex;
        gap: 4px;
        margin-top: 4px;
        flex-wrap: wrap;
    }
    .reaction-item {
        background: rgba(14, 165, 160, 0.1);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 2px 8px;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .reaction-item:hover {
        background: rgba(14, 165, 160, 0.2);
        border-color: var(--accent);
    }
    .reaction-item.my-reaction {
        background: rgba(14, 165, 160, 0.25);
        border-color: var(--accent);
    }

    /* Friend Options Menu */
    .friend-menu {
        position: fixed;
        background: rgba(13, 13, 13, 0.98);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 8px;
        display: none;
        flex-direction: column;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5), 0 0 0 1px var(--border-color);
        z-index: 1000;
        min-width: 180px;
    }
    .friend-menu.show {
        display: flex;
    }
    .friend-menu button {
        background: transparent;
        border: none;
        color: var(--text-muted);
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-family: 'Inter', sans-serif;
        text-align: left;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 10px;
        justify-content: flex-start;
    }
    .friend-menu button:hover {
        background: rgba(14, 165, 160, 0.15);
        color: var(--accent);
    }
    .friend-menu button.danger:hover {
        background: rgba(255, 77, 77, 0.15);
        color: #ff4d4d;
    }
    .friend-menu .material-icons-round {
        font-size: 20px;
    }

    /* Modal/Overlay */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    .modal-overlay.show {
        display: flex;
    }
    .modal-content {
        background: linear-gradient(135deg, rgba(14,165,160,0.05), rgba(14,165,160,0.02));
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 30px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6), 0 0 0 1px var(--border-color);
    }
    .modal-content h3 {
        margin: 0 0 16px;
        font-size: 1.3rem;
        color: var(--text-primary);
    }
    .modal-content p {
        margin: 0 0 24px;
        color: var(--text-muted);
        line-height: 1.6;
    }
    .modal-buttons {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }
    .modal-buttons button {
        padding: 10px 20px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        font-family: 'Inter', sans-serif;
        cursor: pointer;
        transition: all 0.3s;
    }
    .modal-buttons .btn-cancel {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-muted);
    }
    .modal-buttons .btn-cancel:hover {
        background: rgba(255, 255, 255, 0.1);
    }
    .modal-buttons .btn-confirm {
        background: linear-gradient(135deg, #ff4d4d, #e63946);
        color: #fff;
        box-shadow: 0 4px 15px rgba(255, 77, 77, 0.3);
    }
    .modal-buttons .btn-confirm:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 77, 77, 0.5);
    }

    /* Reaction Picker */
    .reaction-picker {
        position: fixed;
        background: rgba(13, 13, 13, 0.98);
        backdrop-filter: blur(10px);
        border-radius: 25px;
        padding: 8px 12px;
        display: none;
        gap: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5), 0 0 0 1px var(--border-color);
        z-index: 1001;
        flex-wrap: nowrap;
    }
    .reaction-picker.show {
        display: flex;
    }
    .reaction-picker span {
        font-size: 1.5rem;
        cursor: pointer;
        transition: transform 0.2s;
        padding: 4px;
        flex-shrink: 0;
    }
    .reaction-picker span:hover {
        transform: scale(1.3);
    }
    .emoji-more-btn {
        background: rgba(14, 165, 160, 0.2);
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
    }
    .emoji-more-btn:hover {
        background: rgba(14, 165, 160, 0.3);
        transform: scale(1.1);
    }

    /* Extended Emoji Picker */
    .emoji-picker-extended {
        position: fixed;
        background: rgba(13, 13, 13, 0.98);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 12px;
        display: none;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5), 0 0 0 1px var(--border-color);
        z-index: 1002;
        max-width: 320px;
    }
    .emoji-picker-extended.show {
        display: grid;
    }
    .emoji-picker-extended span {
        font-size: 1.8rem;
        cursor: pointer;
        transition: transform 0.2s;
        padding: 6px;
        text-align: center;
        border-radius: 8px;
    }
    .emoji-picker-extended span:hover {
        transform: scale(1.3);
        background: rgba(14, 165, 160, 0.15);
    }

    /* Input Area */
    .input-row {
        display: flex;
        gap: 12px;
        padding: 18px 24px;
        border-top: 1px solid var(--border-color);
        background: rgba(14,165,160,0.03);
        border-bottom-left-radius: var(--radius-default);
        border-bottom-right-radius: var(--radius-default);
        flex-shrink: 0;
    }
    textarea {
        flex: 1;
        padding: 12px 18px;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        background: rgba(14,165,160,0.05);
        color: var(--text-primary);
        resize: none;
        outline: none;
        transition: all 0.3s;
        line-height: 1.5;
        min-height: 48px;
        max-height: 120px;
        overflow-y: auto;
        font-family: 'Inter', sans-serif;
        font-size: 0.95rem;
    }
    textarea:focus {
        border-color: var(--accent);
        background: rgba(14,165,160,0.08);
        box-shadow: 0 0 0 3px rgba(14,165,160,0.1);
    }
    textarea::placeholder {
        color: rgba(255,255,255,0.3);
    }
    button.send {
        background: linear-gradient(135deg, var(--accent), var(--accent-hover));
        border: none;
        width: 48px;
        height: 48px;
        min-width: 48px;
        border-radius: 50%;
        color: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 4px 15px rgba(14,165,160,0.4);
        position: relative;
        overflow: hidden;
    }
    button.send::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transition: left 0.5s;
    }
    button.send:hover:not(:disabled)::before {
        left: 100%;
    }
    button.send:disabled {
        background: var(--text-muted);
        opacity: 0.5;
        cursor: not-allowed;
        box-shadow: none;
    }
    button.send:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(14,165,160,0.6);
    }

    /* Mobile Nav */
    .mobile-nav {
        display: none;
        background: rgba(14,165,160,0.05);
        backdrop-filter: blur(10px);
        padding: 12px 16px;
        border-top: 1px solid var(--border-color);
        justify-content: space-around;
        align-items: center;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 50;
    }
    .mobile-nav a {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        color: var(--text-muted);
        font-size: 0.8rem;
        transition: all 0.3s;
        position: relative;
    }
    .mobile-nav a:hover, .mobile-nav a.active {
        color: var(--accent);
    }
    .mobile-nav .material-icons-round {
        font-size: 24px;
    }

    /* Responsive */
    @media (max-width: 992px) {
        .app {
            flex-direction: column;
            height: auto;
            gap: 0;
        }
        .main-container {
            padding: 0;
        }
        .panel {
            border-radius: 0;
            box-shadow: none;
        }
        .left {
            width: 100%;
            min-width: 100%;
            height: calc(100vh - 70px - 60px);
            padding: 15px;
            padding-bottom: 70px;
        }
        .right {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            height: 100dvh;
            z-index: 100;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            background: linear-gradient(180deg, #050505, #0b0b0b);
            border-radius: 0;
            max-height: 100vh;
            max-height: 100dvh;
        }
        .right.active {
            transform: translateX(0);
        }
        .me {
            display: none;
        }
        header.top {
            padding: 12px 15px;
            margin-bottom: 0;
            border-radius: 0;
        }
        #chatHeader {
            border-radius: 0;
            padding: 15px;
        }
        .back-btn {
            display: block !important;
        }
        .input-row {
            border-radius: 0;
            padding: 12px 15px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
            flex-shrink: 0;
        }
        .msg-area {
            padding: 20px;
            padding-bottom: 20px;
            height: auto;
            min-height: 0;
            max-height: calc(100vh - 140px);
            max-height: calc(100dvh - 140px);
            flex: 1;
            overflow-y: auto;
        }
        .mobile-nav {
            display: flex;
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
        }
        .notification-banner {
            margin: 0 10px 10px;
            padding: 12px 15px;
        }
    }

    @media (max-width: 600px) {
        .message-bubble-wrapper {
            max-width: 85%;
        }
        .logo {
            font-size: 20px;
        }
        .logo img {
            width: 32px;
            height: 32px;
        }
    }
</style>
</head>
<body>
    <!-- Notification Permission Banner -->
    <div class="notification-banner" id="notificationBanner">
        <span class="material-icons-round">notifications</span>
        <div class="content">
            <h4>Enable Notifications</h4>
            <p>Get notified when you receive new messages and friend requests</p>
        </div>
        <div class="btns">
            <button class="enable-btn" id="enableNotifications">Enable</button>
            <button class="dismiss-btn" id="dismissNotifications">Not Now</button>
        </div>
    </div>

    <div class="main-container">
        <header class="top">
            <div class="logo">
                <img src="logo.png">
                LB4 Messenger
            </div>
            <div class="me">
                <span class="small">Welcome — <span id="meName">...</span></span>
                <span class="small">|</span>
                <a href="profile.html">Profile</a>
                <span class="small">|</span>
                <a href="search.html" style="position:relative;">
                    Add Friend
                    <span class="notification-badge" id="requestBadge" style="display:none;">0</span>
                </a>
                <span class="small">|</span>
                <a id="logoutBtn" href="#">Logout</a>
            </div>
        </header>

        <div class="app">
            <div id="leftPanel" class="left panel">
                <div class="search">
                    <input id="searchInput" class="search" placeholder="Search friends...">
                </div>
                <div class="contacts-scroll">
                    <h4>Friend Requests</h4>
                    <div id="requestsList"></div>
                    
                    <h4>Your Friends</h4>
                    <div id="friendsList"></div>
                </div>
            </div>

            <div id="rightPanel" class="right panel">
                <div id="chatHeader">
                    <span id="backToContacts" class="material-icons-round back-btn">arrow_back</span>
                    <div style="font-weight:600; color:var(--text-muted); font-size: 1rem;">
                        Select a friend to start chatting
                    </div>
                    <div></div>
                </div>
                <div id="messages" class="msg-area">
                    <div style="text-align:center;color:var(--text-muted);margin:auto;font-size:1rem;">
                        Start a new conversation...
                    </div>
                </div>
                <div class="input-row">
                    <textarea id="messageInput" rows="1" placeholder="Type a message..."></textarea>
                    <button class="send" id="sendBtn" disabled>
                        <span class="material-icons-round">send</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="mobile-nav">
            <a href="home.html" class="active">
                <span class="material-icons-round">chat</span>
                <span>Chats</span>
            </a>
            <a href="profile.html">
                <span class="material-icons-round">person</span>
                <span>Profile</span>
            </a>
            <a href="search.html" style="position:relative;">
                <span class="material-icons-round">person_add</span>
                <span>Add</span>
                <span class="notification-badge" id="requestBadgeMobile" style="display:none;top:-8px;right:8px;">0</span>
            </a>
            <a id="logoutBtnMobile" href="#">
                <span class="material-icons-round">logout</span>
                <span>Logout</span>
            </a>
        </div>
    </div>

    <!-- Notification Sound -->
    <audio id="notificationSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSSF0fPTgjMGHm7A7+OZURE" type="audio/wav">
    </audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { 
        getFirestore, doc, getDoc, updateDoc, deleteField, arrayUnion, onSnapshot, 
        collection, addDoc, setDoc, serverTimestamp, query, orderBy, deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCW7TGm8FQXKasKKeKXw7-f6cZzPOzhGiU",
        authDomain: "lb4-messenger.firebaseapp.com",
        projectId: "lb4-messenger",
        storageBucket: "lb4-messenger.firebasestorage.app",
        messagingSenderId: "373210384215",
        appId: "1:373210384215:web:1a23ab2832bfbacd256012",
        measurementId: "G-EQ7GH30WFQ"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let activeChatId = null;
    let activeFriend = null;
    let unsubscribeMessages = null;
    let lastMessageCount = {};
    let notificationsEnabled = false;

    const rightPanel = document.getElementById('rightPanel');
    const chatHeader = document.getElementById('chatHeader');
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const friendsList = document.getElementById('friendsList');
    const backBtn = document.getElementById('backToContacts');
    const notificationBanner = document.getElementById('notificationBanner');
    const notificationSound = document.getElementById('notificationSound');

    // ==================== NOTIFICATION SYSTEM ====================
    
    // Check notification permission and show banner
    function checkNotificationPermission() {
        if (!('Notification' in window)) {
            console.log('Browser does not support notifications');
            return;
        }

        const permission = Notification.permission;
        
        if (permission === 'default') {
            // Show banner to request permission
            setTimeout(() => {
                notificationBanner.classList.add('show');
            }, 2000);
        } else if (permission === 'granted') {
            notificationsEnabled = true;
        }
    }

    // Request notification permission
    async function requestNotificationPermission() {
        if (!('Notification' in window)) {
            alert('Your browser does not support notifications');
            return false;
        }

        try {
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                notificationsEnabled = true;
                notificationBanner.classList.remove('show');
                showSystemNotification('Notifications Enabled', 'You will now receive notifications for new messages');
                return true;
            }
            return false;
        } catch (error) {
            console.error('Error requesting notification permission:', error);
            return false;
        }
    }

    // Show system notification
    function showSystemNotification(title, body, icon = null, onClick = null) {
        if (!notificationsEnabled || Notification.permission !== 'granted') return;

        try {
            const notification = new Notification(title, {
                body: body,
                icon: icon || 'https://via.placeholder.com/128/0ea5a0/ffffff?text=LB4',
                badge: 'https://via.placeholder.com/96/0ea5a0/ffffff?text=LB4',
                tag: 'lb4-messenger',
                requireInteraction: false,
                silent: false
            });

            if (onClick) {
                notification.onclick = onClick;
            }

            // Auto close after 5 seconds
            setTimeout(() => notification.close(), 5000);
        } catch (error) {
            console.error('Error showing notification:', error);
        }
    }

    // Play notification sound
    function playNotificationSound() {
        if (notificationsEnabled && notificationSound) {
            notificationSound.play().catch(e => console.log('Could not play sound:', e));
        }
    }

    // Event listeners for notification banner
    document.getElementById('enableNotifications').addEventListener('click', async () => {
        await requestNotificationPermission();
    });

    document.getElementById('dismissNotifications').addEventListener('click', () => {
        notificationBanner.classList.remove('show');
    });

    // ==================== HELPER FUNCTIONS ====================

    function positionMenu(menu, triggerElement) {
        const rect = triggerElement.getBoundingClientRect();
        const menuWidth = menu.offsetWidth || 200;
        const menuHeight = menu.offsetHeight || 100;
        const padding = 10;
        
        let top = rect.top - menuHeight - padding;
        let left = rect.left;
        
        if (top < padding) {
            top = rect.bottom + padding;
        }
        
        if (left + menuWidth > window.innerWidth - padding) {
            left = window.innerWidth - menuWidth - padding;
        }
        
        if (left < padding) {
            left = padding;
        }
        
        menu.style.top = top + 'px';
        menu.style.left = left + 'px';
    }

    function toggleChatView(showChat) {
        if (window.innerWidth <= 992) {
            if (showChat) {
                rightPanel.classList.add('active');
            } else {
                rightPanel.classList.remove('active');
                resetChatView();
            }
        }
    }

    function resetChatView() {
        messagesDiv.innerHTML = '<div style="text-align:center;color:var(--text-muted);margin:auto;font-size:1rem;">Start a new conversation...</div>';
        chatHeader.innerHTML = `
            <span id="backToContacts" class="material-icons-round back-btn">arrow_back</span>
            <div style="font-weight:600; color:var(--text-muted); font-size: 1rem;">Select a friend to start chatting</div>
            <div></div>
        `;
        activeChatId = null;
        activeFriend = null;
        messageInput.value = '';
        sendBtn.disabled = true;
        messageInput.style.height = '48px';
        if (unsubscribeMessages) {
            unsubscribeMessages();
            unsubscribeMessages = null;
        }
        document.getElementById('backToContacts').addEventListener('click', () => toggleChatView(false));
    }

    onAuthStateChanged(auth, async user => {
        if (!user) return location.href = 'login.html';
        currentUser = user;
        const uDoc = await getDoc(doc(db, 'users', user.uid));
        const meName = uDoc.exists() ? uDoc.data().displayName || uDoc.data().username : user.email;
        document.getElementById('meName').textContent = meName;
        
        // Check notification permission
        checkNotificationPermission();
        
        listenToFriendRequests();
        loadFriends();
    });

    document.getElementById('logoutBtn').addEventListener('click', async (e) => {
        e.preventDefault();
        await signOut(auth);
        location.href = 'login.html';
    });

    document.getElementById('logoutBtnMobile').addEventListener('click', async (e) => {
        e.preventDefault();
        await signOut(auth);
        location.href = 'login.html';
    });

    sendBtn.addEventListener('click', sendMessage);

    async function sendMessage() {
        const txt = messageInput.value.trim();
        if (!txt || !activeChatId) return;
        
        try {
            await addDoc(collection(db, 'chats', activeChatId, 'messages'), { 
                text: txt, 
                from: currentUser.uid, 
                ts: serverTimestamp(),
                delivered: false,
                read: false
            });
            
            await setDoc(doc(db, 'chatsMeta', activeChatId), { 
                participants: [currentUser.uid, activeFriend.id], 
                last: txt, 
                updatedAt: serverTimestamp() 
            }, { merge: true });
            
            messageInput.value = '';
            sendBtn.disabled = true;
            messageInput.style.height = '48px';
            
            setTimeout(() => {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 100);
        } catch (err) {
            console.error('Error sending message:', err);
            alert('Error sending message');
        }
    }

    messageInput.addEventListener('input', () => {
        sendBtn.disabled = !messageInput.value.trim() || !activeChatId;
        messageInput.style.height = 'auto';
        messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
        if (messageInput.scrollHeight < 48) messageInput.style.height = '48px';
    });

    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!sendBtn.disabled) sendMessage();
        }
    });

    document.getElementById('searchInput').addEventListener('input', (e) => {
        const q = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#friendsList .user-row');
        rows.forEach(r => {
            const name = r.textContent.toLowerCase();
            r.style.display = name.includes(q) ? 'flex' : 'none';
        });
    });

    backBtn.addEventListener('click', () => toggleChatView(false));

    window.addEventListener('resize', () => {
        if (window.innerWidth > 992 && rightPanel.classList.contains('active')) {
            rightPanel.classList.remove('active');
        }
    });

    function listenToFriendRequests() {
        const ref = doc(db, 'friendRequests', currentUser.uid);
        onSnapshot(ref, async (snap) => {
            const box = document.getElementById('requestsList');
            box.innerHTML = '';
            
            const requestCount = snap.exists() ? Object.keys(snap.data()).length : 0;
            const requestBadge = document.getElementById('requestBadge');
            const requestBadgeMobile = document.getElementById('requestBadgeMobile');
            
            if (requestCount > 0) {
                requestBadge.textContent = requestCount;
                requestBadge.style.display = 'block';
                requestBadgeMobile.textContent = requestCount;
                requestBadgeMobile.style.display = 'block';
            } else {
                requestBadge.style.display = 'none';
                requestBadgeMobile.style.display = 'none';
            }
            
            if (!snap.exists() || requestCount === 0) {
                box.innerHTML = '<div class="small" style="text-align:center;padding:10px 0;">No pending requests</div>';
                return;
            }
            
            for (const senderUid in snap.data()) {
                const senderData = snap.data()[senderUid];
                const div = document.createElement('div');
                div.className = 'req-box';
                div.innerHTML = `
                    <div><p><b>${senderData.displayName || senderData.username}</b></p></div>
                    <div class="req-btns">
                        <button class="accept">Accept</button>
                        <button class="reject">Reject</button>
                    </div>
                `;
                div.querySelector('.accept').onclick = () => acceptRequest(senderUid, div, senderData);
                div.querySelector('.reject').onclick = () => rejectRequest(senderUid, div);
                box.appendChild(div);
                
                // Show notification for new friend request
                if (notificationsEnabled) {
                    showSystemNotification(
                        'New Friend Request',
                        `${senderData.displayName || senderData.username} wants to connect with you`,
                        null,
                        () => window.focus()
                    );
                    playNotificationSound();
                }
            }
        });
    }

    async function acceptRequest(senderUid, el, senderData) {
        try {
            const userRef = doc(db, "users", currentUser.uid);
            const senderRef = doc(db, "users", senderUid);
            const reqRef = doc(db, "friendRequests", currentUser.uid);

            await updateDoc(userRef, { friends: arrayUnion(senderUid) });
            await updateDoc(senderRef, { friends: arrayUnion(currentUser.uid) });
            await updateDoc(reqRef, { [senderUid]: deleteField() });
            el.remove();
            loadFriends();
            
            // Show notification
            if (notificationsEnabled) {
                showSystemNotification(
                    'Friend Added',
                    `You and ${senderData.displayName || senderData.username} are now friends!`
                );
            }
        } catch (err) {
            console.error('Error accepting request:', err);
            alert('Error accepting request');
        }
    }

    async function rejectRequest(senderUid, el) {
        try {
            const reqRef = doc(db, "friendRequests", currentUser.uid);
            await updateDoc(reqRef, { [senderUid]: deleteField() });
            el.remove();
        } catch (err) {
            console.error('Error rejecting request:', err);
            alert('Error rejecting request');
        }
    }

    function getInitials(name) {
        if (!name) return '?';
        const parts = name.split(' ');
        if (parts.length > 1) {
            return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        }
        return parts[0][0].toUpperCase();
    }

    async function loadFriends() {
        try {
            const meRef = doc(db, 'users', currentUser.uid);
            const meSnap = await getDoc(meRef);
            const friends = (meSnap.exists() && meSnap.data().friends) ? meSnap.data().friends : [];
            friendsList.innerHTML = '';
            
            if (!friends.length) {
                friendsList.innerHTML = '<div class="small" style="text-align:center;padding:15px 0;">No friends added yet</div>';
                return;
            }

            for (const fid of friends) {
                const fSnap = await getDoc(doc(db, 'users', fid));
                if (!fSnap.exists()) continue;
                const data = fSnap.data();
                const nameText = data.displayName || data.username;

                const el = document.createElement('div');
                el.className = 'user-row';
                el.dataset.friendId = fid;
                el.innerHTML = `
                    <div class="avatar">${getInitials(nameText)}</div>
                    <div style="flex:1;">
                        <div class="name">${nameText}</div>
                        <div class="small">@${data.username}</div>
                    </div>
                `;
                el.addEventListener('click', () => openChatWith(fid, data, el));
                friendsList.appendChild(el);
                
                // Initialize message count for this friend
                const chatId = [currentUser.uid, fid].sort().join('_');
                lastMessageCount[chatId] = 0;
            }
        } catch (err) {
            console.error('Error loading friends:', err);
        }
    }

    function renderChatHeader(friendData) {
        const nameText = friendData.displayName || friendData.username;
        chatHeader.innerHTML = `
            <div style="display:flex;align-items:center;gap:12px;">
                <span id="backToContacts" class="material-icons-round back-btn">arrow_back</span>
                <div class="avatar" style="width:40px;height:40px;font-size:1rem;">${getInitials(nameText)}</div>
                <div>
                    <div style="font-weight:600;font-size:1rem;">${nameText}</div>
                    <div class="small" style="font-size:0.8rem;">@${friendData.username}</div>
                </div>
            </div>
            <div style="position:relative;">
                <span class="material-icons-round" id="friendMenuBtn" style="color:var(--text-muted);cursor:pointer;">more_vert</span>
                <div class="friend-menu" id="friendMenu"></div>
            </div>
        `;
        document.getElementById('backToContacts').addEventListener('click', () => toggleChatView(false));
        
        const friendMenuBtn = document.getElementById('friendMenuBtn');
        const friendMenu = document.getElementById('friendMenu');
        
        friendMenu.innerHTML = `
            <button id="removeFriendBtn">
                <span class="material-icons-round">person_remove</span>
                Remove Friend
            </button>
            <button id="blockFriendBtn" class="danger">
                <span class="material-icons-round">block</span>
                Block User
            </button>
        `;
        
        friendMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isShowing = friendMenu.classList.contains('show');
            
            document.querySelectorAll('.friend-menu, .msg-actions, .reaction-picker, .emoji-picker-extended').forEach(m => {
                m.classList.remove('show');
            });
            
            if (!isShowing) {
                friendMenu.classList.add('show');
                setTimeout(() => positionMenu(friendMenu, friendMenuBtn), 0);
            }
        });
        
        document.addEventListener('click', () => {
            friendMenu.classList.remove('show');
        });
        
        document.getElementById('removeFriendBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            showModal(
                'Remove Friend',
                `Are you sure you want to remove ${friendData.displayName || friendData.username} from your friends list?`,
                async () => {
                    try {
                        await removeFriend(friendData.id);
                        friendMenu.classList.remove('show');
                        toggleChatView(false);
                        loadFriends();
                    } catch (err) {
                        console.error('Error removing friend:', err);
                        alert('Error removing friend');
                    }
                }
            );
        });
        
        document.getElementById('blockFriendBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            showModal(
                'Block User',
                `Do you want to block ${friendData.displayName || friendData.username}? You won't be able to message them again.`,
                async () => {
                    try {
                        await blockFriend(friendData.id);
                        friendMenu.classList.remove('show');
                        toggleChatView(false);
                        loadFriends();
                    } catch (err) {
                        console.error('Error blocking friend:', err);
                        alert('Error blocking user');
                    }
                }
            );
        });
    }

    async function removeFriend(friendId) {
        const userRef = doc(db, "users", currentUser.uid);
        const friendRef = doc(db, "users", friendId);
        
        const userSnap = await getDoc(userRef);
        const friendSnap = await getDoc(friendRef);
        
        if (userSnap.exists()) {
            const friends = userSnap.data().friends || [];
            await updateDoc(userRef, { 
                friends: friends.filter(f => f !== friendId) 
            });
        }
        
        if (friendSnap.exists()) {
            const friends = friendSnap.data().friends || [];
            await updateDoc(friendRef, { 
                friends: friends.filter(f => f !== currentUser.uid) 
            });
        }
    }

    async function blockFriend(friendId) {
        const userRef = doc(db, "users", currentUser.uid);
        const friendRef = doc(db, "users", friendId);
        
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
            const friends = userSnap.data().friends || [];
            const blocked = userSnap.data().blocked || [];
            await updateDoc(userRef, { 
                friends: friends.filter(f => f !== friendId),
                blocked: arrayUnion(friendId)
            });
        }
        
        const friendSnap = await getDoc(friendRef);
        if (friendSnap.exists()) {
            const friends = friendSnap.data().friends || [];
            await updateDoc(friendRef, { 
                friends: friends.filter(f => f !== currentUser.uid)
            });
        }
    }

    function showModal(title, message, onConfirm) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay show';
        modal.innerHTML = `
            <div class="modal-content">
                <h3>${title}</h3>
                <p>${message}</p>
                <div class="modal-buttons">
                    <button class="btn-cancel">Cancel</button>
                    <button class="btn-confirm">Confirm</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        modal.querySelector('.btn-cancel').addEventListener('click', () => {
            modal.remove();
        });
        
        modal.querySelector('.btn-confirm').addEventListener('click', async () => {
            await onConfirm();
            modal.remove();
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    }

    function formatTime(timestamp) {
        if (!timestamp || !timestamp.toDate) return '';
        const date = timestamp.toDate();
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${hours}:${minutes}`;
    }

    async function openChatWith(friendId, friendData, el) {
        try {
            document.querySelectorAll('#friendsList .user-row').forEach(row => row.classList.remove('active'));
            el.classList.add('active');

            activeFriend = { id: friendId, ...friendData };
            renderChatHeader(friendData);
            
            activeChatId = [currentUser.uid, friendId].sort().join('_');
            messagesDiv.innerHTML = '<div style="text-align:center;color:var(--text-muted);margin:20px 0;">Loading...</div>';
            
            sendBtn.disabled = !messageInput.value.trim();
            
            if (unsubscribeMessages) {
                unsubscribeMessages();
            }
            
            const msgsCol = collection(db, 'chats', activeChatId, 'messages');
            const q = query(msgsCol, orderBy('ts', 'asc'));

            unsubscribeMessages = onSnapshot(q, (snap) => {
                const currentMsgCount = snap.docs.length;
                const previousCount = lastMessageCount[activeChatId] || 0;
                
                // Check for new messages from friend (not from current user)
                if (currentMsgCount > previousCount && previousCount > 0) {
                    const newMessages = snap.docs.slice(previousCount);
                    newMessages.forEach(docSnap => {
                        const msgData = docSnap.data();
                        // Only notify if message is from friend and window is not focused
                        if (msgData.from === friendId && !document.hasFocus()) {// ===== PASTE THIS CODE RIGHT AFTER THE LINE: if (msgData.from === friendId && !document.hasFocus()) { =====

                            showSystemNotification(
                                friendData.displayName || friendData.username,
                                msgData.text,
                                null,
                                () => {
                                    window.focus();
                                    openChatWith(friendId, friendData, el);
                                }
                            );
                            playNotificationSound();
                        }
                    });
                }
                
                lastMessageCount[activeChatId] = currentMsgCount;
                
                messagesDiv.innerHTML = '';
                
                snap.docs.forEach(docSnap => {
                    const d = docSnap.data();
                    const msgId = docSnap.id;
                    const isSent = (d.from === currentUser.uid);
                    
                    let statusText = 'Sent';
                    if (isSent) {
                        if (d.read) {
                            statusText = 'Read';
                        } else if (d.delivered) {
                            statusText = 'Delivered';
                        }
                    }

                    const msgEl = document.createElement('div');
                    msgEl.className = `message-row ${isSent ? 'sent' : 'received'}`;
                    
                    let reactionsHTML = '';
                    if (d.reactions && Object.keys(d.reactions).length > 0) {
                        reactionsHTML = '<div class="message-reactions">';
                        const reactionCounts = {};
                        Object.values(d.reactions).forEach(emoji => {
                            reactionCounts[emoji] = (reactionCounts[emoji] || 0) + 1;
                        });
                        Object.entries(reactionCounts).forEach(([emoji, count]) => {
                            const myReaction = d.reactions[currentUser.uid] === emoji ? 'my-reaction' : '';
                            reactionsHTML += `<span class="reaction-item ${myReaction}" data-emoji="${emoji}">${emoji} ${count > 1 ? count : ''}</span>`;
                        });
                        reactionsHTML += '</div>';
                    }
                    
                    msgEl.innerHTML = `
                        <div class="message-bubble-wrapper" style="position:relative;">
                            <div class="emoji-picker-extended"></div>
                            <div class="reaction-picker"></div>
                            <div class="msg-actions"></div>
                            <div class="message-content" data-msg-id="${msgId}">${d.text}</div>
                            ${reactionsHTML}
                            <div class="message-meta">
                                <span>${formatTime(d.ts)}</span>
                                ${isSent ? `<span class="message-status">${statusText}</span>` : ''}
                            </div>
                        </div>
                    `;
                    messagesDiv.appendChild(msgEl);
                    
                    const msgContent = msgEl.querySelector('.message-content');
                    const msgActions = msgEl.querySelector('.msg-actions');
                    const reactionPicker = msgEl.querySelector('.reaction-picker');
                    const emojiPickerExtended = msgEl.querySelector('.emoji-picker-extended');
                    
                    msgActions.innerHTML = `
                        <button class="react-btn"><span class="material-icons-round" style="font-size:16px;">add_reaction</span> React</button>
                        <button class="more-emoji-btn"><span class="material-icons-round" style="font-size:16px;">sentiment_satisfied_alt</span> More</button>
                        ${isSent ? '<button class="delete-btn delete"><span class="material-icons-round" style="font-size:16px;">delete</span> Delete</button>' : ''}
                    `;
                    
                    reactionPicker.innerHTML = `
                        <span data-emoji="❤️">❤️</span>
                        <span data-emoji="😂">😂</span>
                        <span data-emoji="😮">😮</span>
                        <span data-emoji="😢">😢</span>
                        <span data-emoji="🙏">🙏</span>
                        <span data-emoji="👍">👍</span>
                        <div class="emoji-more-btn">➕</div>
                    `;
                    
                    emojiPickerExtended.innerHTML = `
                        <span data-emoji="😊">😊</span>
                        <span data-emoji="🥰">🥰</span>
                        <span data-emoji="😘">😘</span>
                        <span data-emoji="🤣">🤣</span>
                        <span data-emoji="😭">😭</span>
                        <span data-emoji="😍">😍</span>
                        <span data-emoji="🥺">🥺</span>
                        <span data-emoji="😎">😎</span>
                        <span data-emoji="🤔">🤔</span>
                        <span data-emoji="😴">😴</span>
                        <span data-emoji="🤗">🤗</span>
                        <span data-emoji="🙄">🙄</span>
                        <span data-emoji="😡">😡</span>
                        <span data-emoji="🤯">🤯</span>
                        <span data-emoji="🤩">🤩</span>
                        <span data-emoji="😇">😇</span>
                        <span data-emoji="🤪">🤪</span>
                        <span data-emoji="🥳">🥳</span>
                        <span data-emoji="😱">😱</span>
                        <span data-emoji="🤮">🤮</span>
                        <span data-emoji="💀">💀</span>
                        <span data-emoji="🔥">🔥</span>
                        <span data-emoji="💯">💯</span>
                        <span data-emoji="✨">✨</span>
                        <span data-emoji="💔">💔</span>
                    `;
                    
                    msgContent.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const isShowing = msgActions.classList.contains('show');
                        
                        document.querySelectorAll('.msg-actions, .reaction-picker, .emoji-picker-extended, .friend-menu').forEach(m => {
                            m.classList.remove('show');
                        });
                        
                        if (!isShowing) {
                            msgActions.classList.add('show');
                            setTimeout(() => positionMenu(msgActions, msgContent), 0);
                        }
                    });
                    
                    const reactBtn = msgEl.querySelector('.react-btn');
                    if (reactBtn) {
                        reactBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            msgActions.classList.remove('show');
                            emojiPickerExtended.classList.remove('show');
                            const isShowing = reactionPicker.classList.contains('show');
                            
                            if (!isShowing) {
                                reactionPicker.classList.add('show');
                                setTimeout(() => positionMenu(reactionPicker, msgContent), 0);
                            } else {
                                reactionPicker.classList.remove('show');
                            }
                        });
                    }
                    
                    const moreEmojiBtn = msgEl.querySelector('.more-emoji-btn');
                    if (moreEmojiBtn) {
                        moreEmojiBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            msgActions.classList.remove('show');
                            reactionPicker.classList.remove('show');
                            const isShowing = emojiPickerExtended.classList.contains('show');
                            
                            if (!isShowing) {
                                emojiPickerExtended.classList.add('show');
                                setTimeout(() => positionMenu(emojiPickerExtended, msgContent), 0);
                            } else {
                                emojiPickerExtended.classList.remove('show');
                            }
                        });
                    }
                    
                    const emojiMoreBtn = msgEl.querySelector('.emoji-more-btn');
                    if (emojiMoreBtn) {
                        emojiMoreBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            reactionPicker.classList.remove('show');
                            const isShowing = emojiPickerExtended.classList.contains('show');
                            
                            if (!isShowing) {
                                emojiPickerExtended.classList.add('show');
                                setTimeout(() => positionMenu(emojiPickerExtended, msgContent), 0);
                            } else {
                                emojiPickerExtended.classList.remove('show');
                            }
                        });
                    }
                    
                    const deleteBtn = msgEl.querySelector('.delete-btn');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            showModal(
                                'Delete Message',
                                'Do you want to delete this message?',
                                async () => {
                                    try {
                                        await deleteDoc(doc(db, 'chats', activeChatId, 'messages', msgId));
                                        msgActions.classList.remove('show');
                                    } catch (err) {
                                        console.error('Error deleting message:', err);
                                        alert('Error deleting message');
                                    }
                                }
                            );
                        });
                    }
                    
                    reactionPicker.querySelectorAll('span[data-emoji]').forEach(emojiSpan => {
                        emojiSpan.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            const emoji = emojiSpan.dataset.emoji;
                            await addReaction(msgId, emoji, d.reactions);
                            reactionPicker.classList.remove('show');
                        });
                    });
                    
                    emojiPickerExtended.querySelectorAll('span[data-emoji]').forEach(emojiSpan => {
                        emojiSpan.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            const emoji = emojiSpan.dataset.emoji;
                            await addReaction(msgId, emoji, d.reactions);
                            emojiPickerExtended.classList.remove('show');
                        });
                    });
                    
                    msgEl.querySelectorAll('.reaction-item').forEach(item => {
                        item.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            const emoji = item.dataset.emoji;
                            await addReaction(msgId, emoji, d.reactions);
                        });
                    });
                });
                
                async function addReaction(msgId, emoji, currentReactions) {
                    try {
                        const msgRef = doc(db, 'chats', activeChatId, 'messages', msgId);
                        const reactions = currentReactions || {};
                        
                        if (reactions[currentUser.uid] === emoji) {
                            delete reactions[currentUser.uid];
                        } else {
                            reactions[currentUser.uid] = emoji;
                        }
                        
                        await updateDoc(msgRef, { reactions: reactions });
                    } catch (err) {
                        console.error('Error adding reaction:', err);
                    }
                }
                
                document.addEventListener('click', () => {
                    document.querySelectorAll('.msg-actions, .reaction-picker, .emoji-picker-extended, .friend-menu').forEach(m => {
                        m.classList.remove('show');
                    });
                });
                
                setTimeout(() => {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }, 100);
            }, (err) => {
                console.error('Error listening to messages:', err);
                messagesDiv.innerHTML = '<div style="text-align:center;color:#ff4d4d;margin:20px 0;">Error loading messages</div>';
            });

            toggleChatView(true);
        } catch (err) {
            console.error('Error opening chat:', err);
            alert('Error opening chat');
        }
    }
</script>
</body>
</html>
