<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LB4 Messenger â€” Ø¨Ø­Ø«</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#070707;--accent:#10b981;--muted:#cbd5e1}
  *{box-sizing:border-box}
  body{margin:0;font-family:'Cairo',sans-serif;background:linear-gradient(180deg,#040404,#0b0b0b);color:#fff;min-height:100vh}
  .container{max-width:700px;margin:40px auto;padding:20px;background:rgba(255,255,255,0.03);border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
  header a{color:#cbd5e1;text-decoration:none}
  input{width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;margin-bottom:16px}
  .user-card{background:rgba(255,255,255,0.05);padding:10px;border-radius:10px;display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .user-info{display:flex;align-items:center;gap:10px}
  .avatar{width:50px;height:50px;border-radius:50%;background:#222;flex:0 0 50px}
  .btn{padding:8px 12px;border:none;border-radius:8px;cursor:pointer;font-weight:600}
  .add{background:var(--accent);color:#021}
  .added{background:#1e293b;color:#fff;cursor:default}
  .note{color:var(--muted);font-size:0.95rem;margin-bottom:10px}
</style>
</head>
<body>
<div class="container">
  <header>
    <div style="font-weight:800;font-size:20px;color:#fff">LB4 Messenger</div>
    <nav>
      <a href="home.html">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a> â€¢ 
      <a href="#" id="logoutBtn">Ø®Ø±ÙˆØ¬</a>
    </nav>
  </header>

  <h3 style="margin:0 0 6px">ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥Ø¶Ø§ÙØªÙ‡</h3>
  <div class="note">ÙŠÙ…ÙƒÙ†Ùƒ ÙƒØªØ§Ø¨Ø© Ø¨Ø¯Ø§ÙŠØ© Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… â€” Ø§Ù„Ø¨Ø­Ø« ÙŠØ­Ø§ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙˆÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ØªÙØ¶Ø¨Ø· Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«.</div>
  <input type="text" id="searchInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø¬Ø²Ø¡ Ù…Ù†Ù‡...">
  <div id="results"></div>
</div>

<script type="module">
/* Firebase imports */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {
  getFirestore, collection, query, orderBy, startAt, endAt, limit,
  getDocs, doc, getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* Firebase config (Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„ config Ø¹Ù†Ø¯Ùƒ) */
const firebaseConfig = {
  apiKey: "AIzaSyCW7TGm8FQXKasKKeKXw7-f6cZzPOzhGiU",
  authDomain: "lb4-messenger.firebaseapp.com",
  projectId: "lb4-messenger",
  storageBucket: "lb4-messenger.firebasestorage.app",
  messagingSenderId: "373210384215",
  appId: "1:373210384215:web:1a23ab2832bfbacd256012",
  measurementId: "G-EQ7GH30WFQ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;

onAuthStateChanged(auth, user=>{
  if(!user) return location.href='login.html';
  currentUser = user;
  ensureMySearchKey(); // Ø¶Ø¨Ø· searchKey Ù„Ø­Ø³Ø§Ø¨Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
});

/* Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ */
document.getElementById('logoutBtn').addEventListener('click', async (e)=>{
  e.preventDefault();
  await signOut(auth);
  location.href='login.html';
});

/* ÙˆØ¸ÙŠÙØ© debounce Ø¨Ø³ÙŠØ·Ø© */
function debounce(fn, delay=300){
  let t;
  return (...args)=>{
    clearTimeout(t);
    t = setTimeout(()=>fn(...args), delay);
  };
}

/* Ù†Ø¶Ù…Ù† Ø£Ù† ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ÙŠÙØ®Ø²Ù† Ù„Ù‡ Ø­Ù‚Ù„ searchKey (lowercase) */
async function ensureMySearchKey(){
  try{
    const meRef = doc(db,'users', currentUser.uid);
    const meSnap = await getDoc(meRef);
    const uname = meSnap.exists() ? (meSnap.data().username || meSnap.data().displayName || currentUser.email.split('@')[0]) : currentUser.email.split('@')[0];
    await setDoc(meRef, { searchKey: uname.toLowerCase() }, { merge: true });
  }catch(err){
    console.error('ensureMySearchKey error', err);
  }
}

/* Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙØ¹Ù‘Ø§Ù„: ÙŠØ­Ø§ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« Ø¹Ø¨Ø± searchKey Ø£ÙˆÙ„Ø§Ù‹ (fast). 
   Ù„Ùˆ Ù…Ø§ Ø­ØµÙ„ Ù†ØªØ§Ø¦Ø¬ØŒ ÙŠØ¹Ù…Ù„ fallback: ÙŠØ¬Ù„Ø¨ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ø¯ÙˆØ¯Ø© (limit) ÙˆÙŠÙÙ„ØªØ± Ù…Ø­Ù„ÙŠØ§Ù‹ 
   â€” Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† Ø¹Ù…Ù„ Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙˆØ±Ø§Ù‹. */
const resultsEl = document.getElementById('results');
document.getElementById('searchInput').addEventListener('input', debounce(async (e)=>{
  const q = e.target.value.trim().toLowerCase();
  resultsEl.innerHTML = '';
  if(!q) return;

  try{
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø³Ø±ÙŠØ¹Ø© Ø¹Ø¨Ø± searchKey (Ù…ÙØ¶Ù„Ø© Ù„Ø£Ù†Ù‡Ø§ ØªØ³ØªØ®Ø¯Ù… index)
    const qFast = query(collection(db,'users'), orderBy('searchKey'), startAt(q), endAt(q + '\uf8ff'), limit(30));
    const snapFast = await getDocs(qFast);

    if(!snapFast.empty){
      snapFast.forEach(docSnap=>{
        renderUserResult(docSnap.id, docSnap.data());
      });
      return;
    }

    // fallback: Ù†Ø¬ÙŠØ¨ Ø¯ÙØ¹Ø© Ù…Ø­Ø¯ÙˆØ¯Ø© ÙˆÙ†ÙÙ„ØªØ± Ù…Ø­Ù„ÙŠØ§Ù‹ (Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù„Ø§ ÙŠÙ…Ù„ÙƒÙˆÙ† searchKey)
    const qFallback = query(collection(db,'users'), limit(200)); // Ø¹Ø¯Ø¯ Ù…Ø­Ø¯ÙˆØ¯ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙƒÙ„ÙØ©
    const snap = await getDocs(qFallback);
    const matches = [];
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const username = ((d.username||d.displayName||'') + '').toLowerCase();
      if(username.includes(q)) matches.push({ id: docSnap.id, data: d });
    });

    if(matches.length === 0){
      resultsEl.innerHTML = '<div style="color:#999">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø·Ø§Ø¨Ù‚.</div>';
      return;
    }

    // Ù†Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 50 Ù†ØªÙŠØ¬Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙƒØ«Ø±
    matches.slice(0,50).forEach(m => renderUserResult(m.id, m.data));
  }catch(err){
    console.error('search error', err);
    resultsEl.innerHTML = '<div style="color:#f88">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«. Ø§ÙØªØ­ Console Ù„Ù„Ù…Ø²ÙŠØ¯.</div>';
  }
}, 300));

/* Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø²Ø± Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ */
function renderUserResult(uid, data){
  const card = document.createElement('div');
  card.className = 'user-card';
  const display = data.displayName || data.username || uid;
  const username = data.username || display;
  const photo = data.photoURL || '';
  card.innerHTML = `
    <div class="user-info">
      <div class="avatar" style="background: ${photo ? "url('"+photo+"') center/cover" : '#222'}"></div>
      <div>
        <div style="font-weight:700">${display}</div>
        <div style="font-size:0.9em;color:#ccc">@${username}</div>
      </div>
    </div>
    <button class="btn add">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨</button>
  `;
  const btn = card.querySelector('.add');
  btn.onclick = ()=> sendFriendRequest(uid, data, btn);
  resultsEl.appendChild(card);
}

/* Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ â€” ÙŠÙƒØªØ¨ Ø¯Ø§Ø®Ù„ friendRequests/{receiverUid} Ø¨Ù†ÙØ³ Ø¨Ù†ÙŠØ© Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§ */
async function sendFriendRequest(receiverUid, receiverData, btn){
  if(!currentUser) return alert('Ø±Ø¬Ø§Ø¡Ù‹ Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
  if(receiverUid === currentUser.uid) return alert('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ù„Ù†ÙØ³Ùƒ');

  try{
    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ (username Ùˆ displayName)
    const meRef = doc(db,'users', currentUser.uid);
    const meSnap = await getDoc(meRef);
    const meData = meSnap.exists() ? meSnap.data() : {};
    const payload = {
      username: meData.username || (currentUser.email.split('@')[0]),
      displayName: meData.displayName || meData.username || (currentUser.email.split('@')[0]),
      photoURL: meData.photoURL || '',
      time: new Date().toISOString()
    };

    // Ø§ÙƒØªØ¨ Ø§Ù„Ø­Ù‚Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…ÙˆØ­Ø¯
    const receiverRef = doc(db, 'friendRequests', receiverUid);
    // Ù†Ø³ØªØ®Ø¯Ù… get + set (merge) Ù„Ø¹Ø¯Ù… Ù…Ø³Ø­ Ø¨Ù‚ÙŠØ© Ø§Ù„Ø­Ù‚ÙˆÙ„
    // Ù†Ù‚Ø±Ø£ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø«Ù… Ù†Ø¯Ù…Ø¬
    const currentSnap = await getDoc(receiverRef);
    let newData = {};
    if(currentSnap.exists()) newData = currentSnap.data();
    newData[currentUser.uid] = payload;
    await setDoc(receiverRef, newData);
    btn.textContent = 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ…';
    btn.classList.remove('add');
    btn.classList.add('added');
  }catch(err){
    console.error('sendFriendRequest error', err);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨. Ø§ÙØªØ­ Console Ù„Ù„Ù…Ø²ÙŠØ¯.');
  }
}

/* ----- (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„Ù…Ø·ÙˆØ±) : Ø³ÙƒØ±Ø¨Øª ØªØ±Ø­ÙŠÙ„ Ù„Ø¥Ø¶Ø§ÙØ© searchKey Ù„ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©
   Ù†ÙÙ‘Ø°Ù‡ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· (Ø¨Ø¹Ù†Ø§ÙŠØ©) Ù…Ù† Console ÙÙŠ ØµÙØ­Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø¥Ø¹Ø¯Ø§Ø¯ Firebase (Ø£Ùˆ Ù…Ù† Cloud Function).
   Ù„Ø§ ØªØ´ØºÙ„Ù‡ Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙƒØ«ÙŠØ±ÙˆÙ† â€” Ù‚Ø¯ ÙŠØ³ØªÙ‡Ù„Ùƒ Ù‚Ø±Ø§Ø¡Ø§Øª/ÙƒØªØ§Ø¨Ø§Øª ÙƒØ¨ÙŠØ±Ø©.
*/
// async function migrateAllSearchKey(){
//   const usersSnap = await getDocs(query(collection(db,'users'), limit(1000)));
//   for(const docSnap of usersSnap.docs){
//     const d = docSnap.data();
//     const uname = (d.username || d.displayName || '').toLowerCase();
//     await setDoc(doc(db,'users',docSnap.id), { searchKey: uname }, { merge: true });
//   }
//   alert('Migration done (first batch).');
// }

</script>
</body>
</html>
