<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ابحث & أضف صديق — LB4 Messenger</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
 body{margin:0;font-family:'Cairo',sans-serif;background:linear-gradient(180deg,#040404,#0b0b0b);color:#fff;min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:28px}
 .card{width:100%;max-width:720px;background:rgba(255,255,255,0.03);padding:18px;border-radius:12px}
 input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff}
 .user{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;margin-top:8px}
 button.add{background:#10b981;border:none;padding:8px 12px;border-radius:8px;color:#001}
 a.back{display:inline-block;margin-top:12px;color:#cbd5e1;text-decoration:none}
</style>
</head>
<body>
  <div class="card">
    <h2>ابحث عن مستخدم</h2>
    <input id="q" placeholder="ادخل اسم المستخدم للبحث (username)" />
    <div id="results"></div>
    <a class="back" href="home.html">&larr; عودة</a>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, collection, query, where, getDocs, doc, updateDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCW7TGm8FQXKasKKeKXw7-f6cZzPOzhGiU",
    authDomain: "lb4-messenger.firebaseapp.com",
    projectId: "lb4-messenger",
    storageBucket: "lb4-messenger.firebasestorage.app",
    messagingSenderId: "373210384215",
    appId: "1:373210384215:web:1a23ab2832bfbacd256012",
    measurementId: "G-EQ7GH30WFQ"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let me = null;
  onAuthStateChanged(auth, u=>{
    if(!u) location.href='login.html';
    me = u;
  });

  document.getElementById('q').addEventListener('keyup', async (e)=>{
    const val = e.target.value.trim().toLowerCase();
    const results = document.getElementById('results');
    results.innerHTML = '';
    if(!val) return;
    const q = query(collection(db,'users'), where('username','>=',val), where('username','<=', val+'\uf8ff'));
    const snap = await getDocs(q);
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      if(d.uid === me.uid) return;
      const el = document.createElement('div');
      el.className='user';
      el.innerHTML = `<div><strong>${d.displayName||d.username}</strong><div class="small">@${d.username}</div></div><div><button class="add" data-uid="${d.uid}">إرسال طلب</button></div>`;
      results.appendChild(el);
      el.querySelector('.add').addEventListener('click', async ()=>{
        // add to recipient incomingRequests collection (or top-level friend_requests)
        await updateDoc(doc(db,'users', d.uid), { friendRequests: arrayUnion(me.uid) });
        alert('تم إرسال طلب الصداقة');
      });
    });
  });
</script>
</body>
</html>
